# ä½¿ç”¨ REST API çš„å¢é‡åŒæ­¥ï¼ˆæ¨èï¼‰

## ä¸ºä»€ä¹ˆä½¿ç”¨ REST APIï¼Ÿ

ä¸ MCP ç›¸æ¯”ï¼ŒREST API æ–¹å¼å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **æ›´ç¨³å®š**ï¼šç›´æ¥ HTTP è¯·æ±‚ï¼Œä¸ä¾èµ– MCP è¿æ¥
âœ… **æ›´å¯æ§**ï¼šå®Œå…¨æŒæ¡é‡è¯•ã€è¶…æ—¶ã€é”™è¯¯å¤„ç†
âœ… **æ›´å¿«é€Ÿ**ï¼šæ— éœ€ MCP åè®®å¼€é”€
âœ… **æ›´çµæ´»**ï¼šå¯ä»¥åœ¨ä»»ä½• Python ç¯å¢ƒä¸­è¿è¡Œ

## å¿«é€Ÿå¼€å§‹

### 1. è·å– ThetaData API å¯†é’¥

è®¿é—® [ThetaData](https://thetadata.net) æ³¨å†Œå¹¶è·å– API å¯†é’¥ã€‚

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
nano .env

# æ·»åŠ ä»¥ä¸‹è¡Œï¼š
THETADATA_API_KEY=your_actual_api_key_here
```

### 3. æµ‹è¯•è¿æ¥

```bash
# æµ‹è¯•å•æ¬¡åŒæ­¥
python scripts/sync_with_rest_api.py --once
```

### 4. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯10åˆ†é’Ÿï¼‰

**æ–¹æ³• A: Cron ä»»åŠ¡ï¼ˆæ¨èï¼‰**

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯10åˆ†é’Ÿè¿è¡Œï¼‰
*/10 * * * * cd /home/adt/project/agentic_trading && /usr/bin/python3 scripts/sync_with_rest_api.py --once >> logs/sync_rest.log 2>&1
```

**æ–¹æ³• B: åå°å®ˆæŠ¤è¿›ç¨‹**

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# åå°è¿è¡Œ
nohup python scripts/sync_with_rest_api.py --interval 10 > logs/sync_rest.log 2>&1 &

# è®°å½• PID
echo $! > logs/sync_rest.pid

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/sync_rest.log
```

**åœæ­¢å®ˆæŠ¤è¿›ç¨‹**ï¼š

```bash
kill $(cat logs/sync_rest.pid)
```

## å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®šæ—¶ä»»åŠ¡ï¼ˆæ¯10åˆ†é’Ÿï¼‰                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sync_watchlist_incremental()                            â”‚
â”‚  â†’ æ£€æŸ¥å¸‚åœºçŠ¶æ€                                          â”‚
â”‚  â†’ è·å–è§‚å¯Ÿåˆ—è¡¨                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ThetaData REST API                                      â”‚
â”‚  GET https://api.thetadata.us/v2/snapshot/ohlc          â”‚
â”‚  â†’ è·å–å®æ—¶ OHLC å¿«ç…§                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  process_snapshot_and_cache()                            â”‚
â”‚  â†’ ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆå››èˆäº”å…¥åˆ°5åˆ†é’Ÿï¼‰                         â”‚
â”‚  â†’ æ’å…¥æ•°æ®åº“ï¼ˆè‡ªåŠ¨å»é‡ï¼‰                                â”‚
â”‚  â†’ è¿”å›ç»“æœï¼ˆæ–°å¢/é‡å¤ï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLite: data_lake/trades.db                             â”‚
â”‚  UNIQUE(symbol, interval, timestamp) â†’ è‡ªåŠ¨å»é‡          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API å®¢æˆ·ç«¯ä½¿ç”¨

### åŸºæœ¬ç”¨æ³•

```python
from skills.thetadata_client import ThetaDataClient

# åˆå§‹åŒ–å®¢æˆ·ç«¯
client = ThetaDataClient()  # è‡ªåŠ¨ä»ç¯å¢ƒå˜é‡è¯»å– API å¯†é’¥

# è·å– OHLC å¿«ç…§
ohlc = client.get_ohlc_snapshot('AAPL')
print(f"AAPL: Open=${ohlc['open']:.2f}, Close=${ohlc['close']:.2f}")

# è·å–æŠ¥ä»·å¿«ç…§
quote = client.get_quote_snapshot('NVDA')
print(f"NVDA: Bid=${quote['bid']:.2f}, Ask=${quote['ask']:.2f}")
```

### æ‰¹é‡è·å–

```python
from skills.thetadata_client import batch_fetch_snapshots

# æ‰¹é‡è·å–å¤šä¸ªè‚¡ç¥¨
symbols = ['SPY', 'QQQ', 'AAPL', 'NVDA']
snapshots = batch_fetch_snapshots(symbols, delay=0.2)

for symbol, data in snapshots.items():
    if data:
        print(f"{symbol}: ${data['close']:.2f}")
```

### é›†æˆåˆ° Commander

```python
from skills import sync_watchlist_incremental, process_snapshot_and_cache
from skills.thetadata_client import fetch_snapshot_with_rest

# è·å–åŒæ­¥åˆ—è¡¨
sync_info = sync_watchlist_incremental()

if sync_info['should_sync']:
    for symbol in sync_info['symbols_to_sync']:
        # ä½¿ç”¨ REST API è·å–å¿«ç…§
        snapshot = fetch_snapshot_with_rest(symbol)

        # å¤„ç†å¹¶ç¼“å­˜
        result = process_snapshot_and_cache(symbol, snapshot)

        if result['success'] and result['bars_added'] > 0:
            print(f"âœ… {symbol}: New data")
```

## æ€§èƒ½å’Œé™æµ

### API é™åˆ¶

ThetaData API é€šå¸¸æœ‰ä»¥ä¸‹é™åˆ¶ï¼š
- å…è´¹ç‰ˆï¼š100 è¯·æ±‚/åˆ†é’Ÿ
- ä»˜è´¹ç‰ˆï¼šæ ¹æ®è®¢é˜…çº§åˆ«è€Œå®š

### ä¼˜åŒ–ç­–ç•¥

1. **è¯·æ±‚é—´å»¶è¿Ÿ**ï¼šåœ¨è¯·æ±‚ä¹‹é—´æ·»åŠ  0.2 ç§’å»¶è¿Ÿ
2. **æ‰¹é‡å¤„ç†**ï¼šå¦‚æœ API æ”¯æŒï¼Œä½¿ç”¨æ‰¹é‡ç«¯ç‚¹
3. **ç¼“å­˜ç­–ç•¥**ï¼šé¿å…é‡å¤è¯·æ±‚ç›¸åŒæ•°æ®
4. **é”™è¯¯é‡è¯•**ï¼šç½‘ç»œå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•

```python
# å·²å†…ç½®åœ¨ batch_fetch_snapshots() ä¸­
snapshots = batch_fetch_snapshots(
    symbols=['SPY', 'QQQ', 'AAPL'],
    delay=0.2  # é¿å…é™æµ
)
```

## ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹åŒæ­¥æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹
tail -f logs/sync_rest.log

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
tail -n 100 logs/sync_rest.log

# æœç´¢é”™è¯¯
grep "ERROR" logs/sync_rest.log
```

### æ—¥å¿—ç¤ºä¾‹

```
2025-11-20 10:30:15 - INFO - ======================================================================
2025-11-20 10:30:15 - INFO - ğŸ“Š å¢é‡æ•°æ®åŒæ­¥ï¼ˆREST APIï¼‰
2025-11-20 10:30:15 - INFO - ======================================================================
2025-11-20 10:30:15 - INFO - å¸‚åœºçŠ¶æ€: REGULAR
2025-11-20 10:30:15 - INFO - å¸‚åœºå¼€ç›˜: âœ…
2025-11-20 10:30:15 - INFO - éœ€è¦åŒæ­¥: 12 ä¸ªè‚¡ç¥¨
2025-11-20 10:30:15 - INFO - è‚¡ç¥¨åˆ—è¡¨: SPY, QQQ, AAPL, MSFT, NVDA, XLF, XLK, AMD, TSLA, DIA, IWM, XLE
2025-11-20 10:30:15 - INFO -
2025-11-20 10:30:15 - INFO - å¼€å§‹åŒæ­¥...
2025-11-20 10:30:15 - INFO -
2025-11-20 10:30:15 - INFO - [1/12] SPY... âœ… æ–°å¢ @ 2025-11-20T10:30:00-05:00
2025-11-20 10:30:16 - INFO - [2/12] QQQ... â­ï¸  å·²å­˜åœ¨ï¼ˆè·³è¿‡ï¼‰
2025-11-20 10:30:16 - INFO - [3/12] AAPL... âœ… æ–°å¢ @ 2025-11-20T10:30:00-05:00
...
2025-11-20 10:30:20 - INFO - ======================================================================
2025-11-20 10:30:20 - INFO - åŒæ­¥å®Œæˆ
2025-11-20 10:30:20 - INFO - ======================================================================
2025-11-20 10:30:20 - INFO - âœ… æˆåŠŸ:   12/12
2025-11-20 10:30:20 - INFO - ğŸ†• æ–°å¢:   3
2025-11-20 10:30:20 - INFO - â­ï¸  é‡å¤:   9
2025-11-20 10:30:20 - INFO - âŒ å¤±è´¥:   0
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šAPI å¯†é’¥æ— æ•ˆ

```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $THETADATA_API_KEY

# æˆ–æŸ¥çœ‹ .env æ–‡ä»¶
grep THETADATA_API_KEY .env

# æµ‹è¯• API å¯†é’¥
python -c "
from skills.thetadata_client import ThetaDataClient
client = ThetaDataClient()
print('âœ… API å¯†é’¥æœ‰æ•ˆ')
"
```

### é—®é¢˜ï¼šè¯·æ±‚è¶…æ—¶

```python
# åœ¨ thetadata_client.py ä¸­å¢åŠ è¶…æ—¶æ—¶é—´
response = self.session.get(url, params=params, timeout=30)  # å¢åŠ åˆ°30ç§’
```

### é—®é¢˜ï¼šAPI é™æµ

```bash
# å¢åŠ è¯·æ±‚é—´å»¶è¿Ÿ
python scripts/sync_with_rest_api.py --once  # é»˜è®¤ 0.2 ç§’

# æˆ–ä¿®æ”¹ thetadata_client.py ä¸­çš„ delay å‚æ•°
batch_fetch_snapshots(symbols, delay=0.5)  # å¢åŠ åˆ° 0.5 ç§’
```

## ä¸ MCP ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | REST API ç‰ˆæœ¬ | MCP ç‰ˆæœ¬ |
|------|--------------|----------|
| **ç¨³å®šæ€§** | â­â­â­â­â­ | â­â­â­ |
| **é€Ÿåº¦** | â­â­â­â­â­ | â­â­â­â­ |
| **çµæ´»æ€§** | â­â­â­â­â­ | â­â­â­ |
| **é…ç½®å¤æ‚åº¦** | ç®€å•ï¼ˆåªéœ€ API å¯†é’¥ï¼‰ | å¤æ‚ï¼ˆéœ€é…ç½® MCPï¼‰ |
| **ç‹¬ç«‹æ€§** | å¯ç‹¬ç«‹è¿è¡Œ | éœ€è¦ Claude Code |
| **é”™è¯¯å¤„ç†** | å®Œå…¨å¯æ§ | ä¾èµ– MCP å±‚ |
| **æ¨èåœºæ™¯** | ç”Ÿäº§ç¯å¢ƒ | å¼€å‘/åŸå‹ |

## æ¨èé…ç½®

### ç”Ÿäº§ç¯å¢ƒ

```bash
# 1. é…ç½® API å¯†é’¥
echo "THETADATA_API_KEY=your_key" >> .env

# 2. è®¾ç½® Cronï¼ˆæ¯10åˆ†é’Ÿï¼‰
crontab -e
# æ·»åŠ ï¼š
*/10 * * * * cd /home/adt/project/agentic_trading && /usr/bin/python3 scripts/sync_with_rest_api.py --once >> logs/sync_rest.log 2>&1

# 3. è®¾ç½®æ—¥å¿—è½®è½¬
sudo nano /etc/logrotate.d/agentic-trading
# å†…å®¹ï¼š
/home/adt/project/agentic_trading/logs/sync_rest.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
```

## æ€»ç»“

REST API ç‰ˆæœ¬æ˜¯**ç”Ÿäº§ç¯å¢ƒæ¨èæ–¹æ¡ˆ**ï¼š

âœ… æ›´ç¨³å®šã€æ›´å¿«é€Ÿã€æ›´å¯æ§
âœ… ç®€å•é…ç½®ï¼ˆåªéœ€ API å¯†é’¥ï¼‰
âœ… å¯åœ¨ä»»ä½•ç¯å¢ƒè¿è¡Œ
âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

ç«‹å³å¼€å§‹ï¼š

```bash
# 1. è®¾ç½® API å¯†é’¥
echo "THETADATA_API_KEY=your_key" >> .env

# 2. æµ‹è¯•è¿è¡Œ
python scripts/sync_with_rest_api.py --once

# 3. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯10åˆ†é’Ÿï¼‰
crontab -e
# æ·»åŠ ï¼š*/10 * * * * cd /path/to/agentic_trading && python scripts/sync_with_rest_api.py --once
```

ğŸ‰ å®Œæˆï¼ä½ ç°åœ¨æœ‰äº†ä¸€ä¸ªç¨³å®šçš„æ¯10åˆ†é’Ÿå¢é‡åŒæ­¥ç³»ç»Ÿï¼
